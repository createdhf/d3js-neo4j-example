<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="A d3js example for neo4j">
  <meta name="author" content="Mic Wan">

  <title>D3js Example for neo4j</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <!-- Custom styles for this template -->
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

  <div class="container-fluid">
    <div class="row">
      <div class="col col-12 col-md-12 form-inline">
        <input type="text" class="form-control form-control-sm" size="40px" id="cypher" placeholder="Cypher">
        <button type="button" class="btn btn-outline-primary btn-sm" id="btnSend">
          <i class="fa fa-check" aria-hidden="true"></i> Send&nbsp;
        </button>
      </div>
    </div>
  </div>

  <hr/>

  <div class="container-fluid">
    <div class="row">
      <div class="col col-12 col-md-12" id="graphContainer">
        <svg id="resultSvg"></svg>
      </div>
    </div>
  </div>

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/d3.v5.min.js"></script>
  <script type="text/javascript">
    "use strict";

    //######################### const #########################
    var graphWidth = 1024;
    var graphHeight = 500;

    var neo4jAPIURL = 'http://localhost:7474/db/data/transaction/commit';
    var neo4jLogin = 'neo4j';
    var neo4jPassword = 'password';

    var circleSize = 30;

    //######################### variable #########################
    var nodeItemMap = new Map();
    var linkItemMap = new Map();

    var d3Simulation = null;
    var circles;
    var lines;
    var allText;

    var itemColorMap = new Map();
    var colorScale = d3.scaleOrdinal(d3.schemeSet3);

    var drag_handler = d3.drag()
      .on("start", drag_start)
      .on("drag", drag_move)
      .on("end", drag_end);

    function removeAlert() {
      $('div.alert').remove();
    }

    function promptAlert(targetElement, msgText, isError) {
      removeAlert();

      var alertType;
      if (!isError)
        alertType = 'info';
      else
        alertType = 'danger';

      var alertDiv = $('<div class="alert alert-' + alertType + ' alert-dismissible fade show" role="alert"></div>');
      var alertCloseBtn = $('<button type="button" class="close" data-dismiss="alert" aria-label="Close"></button>');
      alertCloseBtn.append($('<i class="fa fa-times" aria-hidden="true"></i>'));
      alertDiv.append(alertCloseBtn);

      alertDiv.append(msgText);
      targetElement.prepend(alertDiv);
    }

    function neo4jLoginForAjax() {
      $.ajaxSetup({
        contentType: 'application/json',
        beforeSend: function(xhr) {
          xhr.setRequestHeader ('Authorization', 'Basic ' + btoa(neo4jLogin + ':' + neo4jPassword));
        }
      });
    }

    function drag_start(d) {
      if (!d3.event.active && d3Simulation != null)
        d3Simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function drag_move(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function drag_end(d) {
      if (!d3.event.active && d3Simulation != null)
        d3Simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    function initGraph() {
      var svg = d3.select('#resultSvg');
      var defs = svg.append('defs');

      svg.attr('width', graphWidth)
        .attr('height', graphHeight);

      // define arrow markers for graph links
      defs.append('marker')
        .attr('id', 'end-arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 6)
        .attr('markerWidth', 3)
        .attr('markerHeight', 3)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', '#000');

      defs.append('marker')
        .attr('id', 'start-arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 4)
        .attr('markerWidth', 3)
        .attr('markerHeight', 3)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M10,-5L0,0L10,5')
        .attr('fill', '#000');

      svg.append('g').attr('id', 'circle-group');
      svg.append('g').attr('id', 'path-group');
      svg.append('g').attr('id', 'text-group');
    }

    function stopSimulation() {
      if (d3Simulation != null) {
        d3Simulation.stop()
          .on('tick', null);
        d3Simulation = null;
      }
    }

    function tick() {
      circles.attr('transform', transform);
      //text.attr('transform', transform);
    }

    function transform(d) {
      //console.log(d);
      return 'translate(' + d.x + ',' + d.y + ')';
    }

    function plotGraph() {
      d3Simulation = d3.forceSimulation()
        //.force('chargeForce', d3.forceManyBody())//.strength(-300)
        .force('collideForce', d3.forceCollide(circleSize * 1.2))
        .force('centerForce', d3.forceCenter(graphWidth / 2, graphHeight / 2))
        //.force('linkForce', d3.forceLink().distance(60))
        .nodes(Array.from(nodeItemMap));
        //.force('linkForce').links(Array.from(linkItemMap));

      circles = d3.select('#circle-group').selectAll('circle')
        .data(d3Simulation.nodes(), function(d) {return d.id;});

      circles.exit().remove();

      circles = circles.enter().append('circle')
        .attr('r', circleSize)
        .attr('fill', getItemColor)
        .attr('stroke', getItemStrokeColor)
        .call(drag_handler)
        .merge(circles);

      d3Simulation.on('tick', tick);
    }

    function submitQuery(isUpdate) {
      removeAlert();

      var queryStr = $.trim($('#cypher').val());
      if (queryStr == '') {
        promptAlert($('#graphContainer'), 'Error: cypher cannot be empty !', true);
        return;
      }

      stopSimulation();

      if (isUpdate == null || !isUpdate) {
        nodeItemMap.clear();
        linkItemMap.clear();
      }

      var jqxhr = $.post(neo4jAPIURL, '{"statements":[{"statement":"' + queryStr + '", "resultDataContents":["graph"]}]}', 
        function(data) {
          console.log(JSON.stringify(data));
          if (data.errors != null && data.errors.length > 0) {
            promptAlert($('#graphContainer'), 'Error: ' + data.errors[0].message + '(' + data.errors[0].code + ')', true);
            return;
          }

          if (data.results != null && data.results.length > 0 && data.results[0].data != null && data.results[0].data.length > 0) {
            var neo4jDataItmArray = data.results[0].data;
            neo4jDataItmArray.forEach(function(dataItem) {
              //Node
              if (dataItem.graph.nodes != null && dataItem.graph.nodes.length > 0) {
                var neo4jNodeItmArray = dataItem.graph.nodes;
                neo4jNodeItmArray.forEach(function(nodeItm) {
                  if (!nodeItemMap.has(nodeItm.id))
                    nodeItemMap.set(nodeItm.id, nodeItm);
                });
              }
              //Link
              if (dataItem.graph.relationships != null && dataItem.graph.relationships.length > 0) {
                var neo4jLinkItmArray = dataItem.graph.relationships;
                neo4jLinkItmArray.forEach(function(linkItm) {
                  if (!linkItemMap.has(linkItm.id))
                    linkItemMap.set(linkItm.id, linkItm);
                });
              }
            });

            console.log('nodeItemMap.size:' + nodeItemMap.size);
            console.log('linkItemMap.size:' + linkItemMap.size);

            plotGraph();
            return;
          }

          promptAlert($('#graphContainer'), 'No record found !', false);
        }, 'json');

      jqxhr.fail(function(data) {
        promptAlert($('#graphContainer'), 'Error: submit cypher but got error return (' + data + ')', true);
      });
    }

    function getItemColor(d) {
      if (!itemColorMap.has(d[1].labels[0])) {
        itemColorMap.set(d[1].labels[0], colorScale(d[1].labels[0]));
      }
      return itemColorMap.get(d[1].labels[0]);
    }

    function getItemStrokeColor(d) {
      return d3.rgb(getItemColor(d)).darker().toString();
    }

    //Page Init
    $(function() {
      neo4jLoginForAjax();

      initGraph();

      $('#cypher').keyup(function(e) {
        if(e.which == 13) {
          submitQuery();
        }
      });

      $('#btnSend').click(submitQuery);
    });
  </script>
</body>
</html>